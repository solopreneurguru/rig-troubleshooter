# Architecture & Endpoints

**Last updated:** 2025-09-03 03:11 

## Stack
- **Frontend**: Next.js 15 (App Router, TypeScript)
- **Backend**: Next.js Route Handlers (serverless on Vercel)
- **Data**: Airtable (system of record)
- **Files**: Vercel Blob (public URLs stored in Airtable Documents)
- **Auth**: Vercel protection (optional during testing)
- **PDF**: server-side render to Blob, URL stored on Finding

## Pages
- `/` — home / status
- `/upload` — upload file → Blob → create Documents row
- `/sessions/new` — create session (Rig optional) + choose RulePack
- `/sessions/[id]` — StepCard workspace

## APIs (route handlers)
- **Env/Health**
  - `GET /api/env` — presence map for expected env vars
  - `GET /api/airtable/health` — PAT/base reachability
- **RulePacks**
  - `GET /api/rulepacks/list` — active packs (v1 & v2, with `isV2`)
  - `POST /api/rulepacks/validate` — zod validation for v2
  - `POST /api/rulepacks/simulate` — dev-only simulator for v2
- **Sessions/Planner**
  - `POST /api/sessions/create` — new session (+ rig link, rulepack)
  - `POST /api/plan/next` — first/next step for a session
  - `POST /api/plan/submit` — record reading, set pass/fail, advance
- **Actions/Safety**
  - `POST /api/actions/confirm-hazard` — set ConfirmedBy/At/HazardNote
- **Auth (Tech)**
  - `POST /api/auth/tech/login` — create/get tech record by email
- **Documents**
  - `POST /api/blob/upload` — upload to Blob (used by `/upload`)

## Data flow
1) Upload → Blob URL → Documents row.
2) New Session → pick RulePack → planner creates first Action.
3) Submit reading → create Reading row; update Action.Result; compute next node.
4) SafetyGate → require tech + checkbox → writes ConfirmedBy/At (+ HazardNote if provided).
5) Finish/Escalate → create Finding + PDF; email automation (Airtable).

## Observability & Reliability
- Log JSON per API: include `sessionId`, `actionId`, `techId`.
- Add `/api/health` to return Airtable reachability + required select options present.
- Cache `GET /api/rulepacks/list` (e.g., 60s) to reduce Airtable calls.


### API map
<!-- AUTOGEN:API-START -->
> _autogenerated 2025-09-03 04:07:03Z_
| Endpoint | Methods |
|---|---|
| `/api/actions/confirm-hazard` | POST |
| `/api/airtable/health` | GET |
| `/api/auth/tech/login` | POST |
| `/api/blob/upload` | POST |
| `/api/env` | GET |
| `/api/findings/create` | POST |
| `/api/plan/next` | POST |
| `/api/plan/submit` | POST |
| `/api/report/[sessionId]` | GET |
| `/api/rulepacks/list` | GET |
| `/api/rulepacks/simulate` | GET, POST |
| `/api/rulepacks/test` | GET |
| `/api/rulepacks/validate` | GET, POST |
| `/api/sessions/create` | POST |
<!-- AUTOGEN:API-END -->
