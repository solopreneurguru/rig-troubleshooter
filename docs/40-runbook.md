# Runbook — Smoke Tests, Troubleshooting & Recovery

**Last updated:** 2025-09-03 03:11 

## Five-minute smoke (Production)
1) `/api/env` → all keys “✓ set” (esp. `TB_RULEPACKS`, `TB_TECHS`, `SESSIONS_RULEPACK_FIELD`).
2) `/api/rulepacks/list` → at least one **Active** pack.
3) `/sessions/new` → dropdown shows packs; create a session.
4) StepCard → enter reading + pass/fail; next step advances; Actions & Readings rows created.
5) SafetyGate → sign in as tech; LOTO checkbox; continue; `ConfirmedBy/At` written.
6) Finding → create; PDF ReportURL opens; email automation fires (if enabled).
7) `/upload` → upload a file; Documents row appears with BlobURL.

## Common issues
- **Select option errors**: Pre-create values (Actions.Result: `Pending`, `Pass`, `Fail`; Findings.Outcome: `Resolved`, `Monitor`, `Escalate-Electrical`, `Escalate-Mechanical`, `Escalate-Controls`).
- **No packs listed**: `Active` must be a checkbox; `Json` valid JSON.
- **Tech confirm missing**: Ensure `TB_TECHS` set; Techs table has **Email**; Actions has `ConfirmedBy/At`.
- **Airtable PAT error**: token must include `data.records:read/write` and base access; avoid newline in PAT.

## Recovery
- Verify env vars in Vercel → redeploy.
- Confirm table IDs match the base; link fields are `["recXXX"]`.
- If Vercel protection blocks POSTs, disable temporarily or use bypass cookie URL.

## PR checklist
- [ ] `/api/env` OK
- [ ] `/api/rulepacks/list` has ≥ 1 active pack
- [ ] `/sessions/new` works end-to-end
- [ ] Docs updated (schema/feature/runbook)
- [ ] CHANGELOG updated


### Smoke API Map
<!-- AUTOGEN:API-START -->
> _autogenerated 2025-09-03 04:07:03Z_
| Endpoint | Methods |
|---|---|
| `/api/actions/confirm-hazard` | POST |
| `/api/airtable/health` | GET |
| `/api/auth/tech/login` | POST |
| `/api/blob/upload` | POST |
| `/api/env` | GET |
| `/api/findings/create` | POST |
| `/api/plan/next` | POST |
| `/api/plan/submit` | POST |
| `/api/report/[sessionId]` | GET |
| `/api/rulepacks/list` | GET |
| `/api/rulepacks/simulate` | GET, POST |
| `/api/rulepacks/test` | GET |
| `/api/rulepacks/validate` | GET, POST |
| `/api/sessions/create` | POST |
<!-- AUTOGEN:API-END -->
